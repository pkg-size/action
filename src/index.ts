import assert from 'assert';
import { getInput, setFailed } from '@actions/core';
import { context } from '@actions/github';
import type { PullRequest } from '@octokit/webhooks-types';
import { sub } from './lib/markdown';
import upsertComment from './lib/upsert-comment';
import generateSizeReport from './lib/generate-size-report';
import * as log from './lib/log';
import exec from './lib/exec';

const COMMENT_SIGNATURE = sub('ðŸ¤– This report was automatically generated by [pkg-size-action](https://github.com/pkg-size/action/)');

(async () => {
	assert(context.eventName === 'pull_request', 'Current only pull requests are supported');

	const { GITHUB_TOKEN } = process.env;
	assert(GITHUB_TOKEN, 'Environment variable "GITHUB_TOKEN" not set. Required for accessing and reporting on the PR.');

	const pr = context.payload.pull_request as PullRequest;

	const sizeReport = await generateSizeReport({
		pr,
		buildCommand: getInput('build-command'),
		commentReport: getInput('comment-report'),
		mode: getInput('mode') || 'regression',
		unchangedFiles: getInput('unchanged-files') || 'collapse',
		hideFiles: getInput('hide-files'),
		sortBy: getInput('sort-by') || 'delta',
		sortOrder: getInput('sort-order') || 'desc',
		displaySize: getInput('display-size') || 'uncompressed',
	});
	await exec(`git checkout -f ${context.sha}`);

	if (sizeReport) {
		await upsertComment({
			token: GITHUB_TOKEN,
			commentSignature: COMMENT_SIGNATURE,
			repo: context.repo,
			prNumber: pr.number,
			body: sizeReport,
		});
	}
})().catch((error) => {
	setFailed(error.message);
	log.warning(error.stack);
});
